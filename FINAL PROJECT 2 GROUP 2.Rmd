---
title: "Predicting Wildfire Occurrence Using Climate Variables"
author: "SIMBANEGAVI_SIMBARASHE
        JEONGWON YOO
        NITHIN RAVINDRA REEDY"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
options(repos = c(CRAN = "https://cloud.r-project.org"))

required_packages <- c(
  "sf", "ggplot2", "tidyverse", 
  "tidymodels", "themis"   
)

new_packages <- required_packages[
  !(required_packages %in% installed.packages()[, "Package"])
]

if (length(new_packages)) {
  install.packages(new_packages)
}

library(sf)
library(ggplot2)
library(tidyverse)
library(tidymodels)
library(themis)   
```

```{r global-options, include=FALSE}
# Some of common RMD options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
knitr::opts_chunk$set(results="markup", warning = F, message = F)
# Can globally set option for number display format.
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
```

## 1. Load data
```{r}
fire_all <- read_csv("C:/Users/SIMBAH/Desktop/Fire_Incidence_Data 2018-2019.csv")
glimpse(fire_all)
```
## 2.Confirm years in the Data
```{r}
table(fire_all$Year)
```
## 3.Select Target + Climate Predictors + Location
```{r}
fire_model <- fire_all %>%
select(
Wildfire,     # TARGET (Yes/No)
Year,
latitude,
longitude,
pr,
rmax,
rmin,
sph,
srad,
tmmn
) %>%
drop_na()

glimpse(fire_model)
```
## 4.Convert Wildfire to a Factor
```{r}
fire_model <- fire_model %>%
mutate(Wildfire = as.factor(Wildfire))

levels(fire_model$Wildfire)
```
## 5.Temporal Split (2018 = TRAIN, 2019 = TEST)
```{r}
fire_train <- fire_model %>%
filter(Year == 2018)

fire_test <- fire_model %>%
filter(Year == 2019)

nrow(fire_train)
nrow(fire_test)
```
## 6. Preprocessing Recipe (Training Data ONLY)

```{r recipe}
fire_recipe <- recipe(
  Wildfire ~ .,
  data = fire_train
) %>%
  step_rm(Year) %>%                     
  step_normalize(all_numeric_predictors()) %>%
  step_upsample(Wildfire)

```

## 7. Define the KNN Classification Model
```{r}
knn_model <- nearest_neighbor(
neighbors = 5,
weight_func = "rectangular",
dist_power = 2
) %>%
set_engine("kknn") %>%
set_mode("classification")

knn_model
```
## 8. Create the Workflow
```{r}
fire_wf <- workflow() %>%
add_recipe(fire_recipe) %>%
add_model(knn_model)

fire_wf
```
## 9. Train the Model on 2018 Data
```{r}
knn_fit <- fit(fire_wf, data = fire_train)
```
## 10. Predict Wildfire Occurrence for 2019
```{r}
fire_predictions <- predict(knn_fit, fire_test) %>%
bind_cols(fire_test)

head(fire_predictions)
```

## 11. Confusion Matrix (Prediction Performance)
```{r}
conf_mat(
fire_predictions,
truth = Wildfire,
estimate = .pred_class
)
```
After applying upsampling to address class imbalance, the KNN model demonstrated an improved ability to detect wildfire events. The confusion matrix shows that the model correctly classified 24,520 non-wildfire cases and successfully detected 137 wildfire occurrences. However, 930 wildfire cases were still misclassified as non-wildfire (false negatives), and 2,380 non-wildfire cases were incorrectly predicted as wildfire (false positives). Although some misclassification remains, the model shows a substantial improvement compared to the imbalanced version, which failed to detect any wildfire events. This result highlights the importance of addressing class imbalance in wildfire prediction tasks.

## 12. Classification Metrics (Accuracy, Recall, Precision, F1)

```{r metrics}
metric_set(accuracy, precision, recall, f_meas)(
  fire_predictions,
  truth = Wildfire,
  estimate = .pred_class,
  event_level = "second"   # ✅ This makes "Yes" (Wildfire) the positive class
)
```
After specifying wildfire (“Yes”) as the positive class, the KNN model achieved an overall accuracy of 88.2%; however, its performance in detecting wildfire events was limited. The precision was 5.44%, indicating that only a small proportion of predicted wildfire events corresponded to actual wildfires. The recall was 12.84%, meaning that the model detected only about one out of every eight real wildfires. The F1-score of 7.65% further confirms the weak balance between precision and recall for wildfire detection. These results suggest that while the model performs well in identifying non-wildfire conditions, it struggles to reliably detect wildfire occurrences. This limitation is largely attributed to the strong class imbalance and the inherent complexity of wildfire–climate relationships.

## 13. Kappa

```{r kappa_wildfire}
metric_set(kap)(
  fire_predictions,
  truth = Wildfire,
  estimate = .pred_class,
  event_level = "second"   # "Yes" (Wildfire) is the positive class
)

```
Although the KNN model achieved high accuracy, the very low Kappa value confirms that its predictive power for wildfire occurrence is weak and only marginally better than random guessing.

## 14. ROC-AUC 

```{r fire-prob}
# Get predicted probabilities for both classes
fire_prob <- predict(knn_fit, fire_test, type = "prob") %>%
  bind_cols(fire_test)

# Check the probability column names
colnames(fire_prob)
```
```{r roc-plot, fig.width=7, fig.height=6}
# Create ROC object
roc_obj <- roc_curve(
  fire_prob,
  truth = Wildfire,
  .pred_Yes,
  event_level = "second"
)

# Plot ROC curve using ggplot
autoplot(roc_obj) +
  ggtitle("ROC Curve for KNN Wildfire Prediction (2019)") +
  theme_minimal()

```


